local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- 1. CẤU HÌNH GIAO DIỆN (GUI)
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MyToggleGUI"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false 

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 200, 0, 150) -- Kích thước gốc khi mở
MainFrame.Position = UDim2.new(0.5, -100, 0.5, -75) 
MainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true -- QUAN TRỌNG: Cắt bỏ phần thừa khi thu nhỏ
MainFrame.Parent = ScreenGui

-- Bo tròn góc
local UICornerMain = Instance.new("UICorner")
UICornerMain.CornerRadius = UDim.new(0, 10)
UICornerMain.Parent = MainFrame

-- Tiêu đề
local Title = Instance.new("TextLabel")
Title.Text = "MENU CHỨC NĂNG"
Title.Size = UDim2.new(1, -30, 0, 30) -- Chừa chỗ cho nút thu nhỏ
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = MainFrame

----------------------------------------------------------
-- [MỚI] NÚT THU NHỎ / MỞ RỘNG (MINIMIZE BUTTON)
----------------------------------------------------------
local MinBtn = Instance.new("TextButton")
MinBtn.Name = "MinimizeButton"
MinBtn.Text = "-"
MinBtn.Size = UDim2.new(0, 30, 0, 30)
MinBtn.Position = UDim2.new(1, -30, 0, 0) -- Góc trên phải
MinBtn.BackgroundTransparency = 1
MinBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
MinBtn.Font = Enum.Font.GothamBold
MinBtn.TextSize = 24
MinBtn.Parent = MainFrame

local isMinimized = false
local originalHeight = MainFrame.Size.Y.Offset -- Lưu chiều cao gốc (150)

MinBtn.MouseButton1Click:Connect(function()
	isMinimized = not isMinimized -- Đảo trạng thái

	if isMinimized then
		-- Thu nhỏ: Chỉ còn chiều cao 30 (bằng thanh tiêu đề)
		TweenService:Create(MainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {Size = UDim2.new(0, 200, 0, 30)}):Play()
		MinBtn.Text = "+" -- Đổi dấu thành cộng
	else
		-- Mở rộng: Trở về chiều cao gốc
		TweenService:Create(MainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {Size = UDim2.new(0, 200, 0, originalHeight)}):Play()
		MinBtn.Text = "-" -- Đổi dấu thành trừ
	end
end)

----------------------------------------------------------
-- CHỨC NĂNG KÉO THẢ (DRAGGABLE)
----------------------------------------------------------
local dragging, dragInput, dragStart, startPos

local function update(input)
	local delta = input.Position - dragStart
	MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

MainFrame.InputBegan:Connect(function(input)
	if (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
		-- Chỉ cho phép kéo khi bấm vào vùng tiêu đề (chiều cao < 30)
		-- để tránh bị kẹt khi bấm vào các nút chức năng
		if input.Position.Y - MainFrame.AbsolutePosition.Y < 30 then 
			dragging = true
			dragStart = input.Position
			startPos = MainFrame.Position
			
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end
end)

MainFrame.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		update(input)
	end
end)

----------------------------------------------------------
-- 2. HÀM TẠO NÚT TOGGLE
----------------------------------------------------------
function createToggle(name, positionY, callback)
    local ToggleFrame = Instance.new("Frame")
    ToggleFrame.Size = UDim2.new(1, -20, 0, 40)
    ToggleFrame.Position = UDim2.new(0, 10, 0, positionY)
    ToggleFrame.BackgroundTransparency = 1
    ToggleFrame.Parent = MainFrame

    local Label = Instance.new("TextLabel")
    Label.Text = name
    Label.Size = UDim2.new(0.6, 0, 1, 0)
    Label.BackgroundTransparency = 1
    Label.TextColor3 = Color3.fromRGB(100, 200, 255)
    Label.Font = Enum.Font.GothamBold
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.TextSize = 14
    Label.Parent = ToggleFrame

    local ButtonBg = Instance.new("TextButton")
    ButtonBg.Text = ""
    ButtonBg.Size = UDim2.new(0, 50, 0, 24)
    ButtonBg.Position = UDim2.new(1, -50, 0.5, -12)
    ButtonBg.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    ButtonBg.AutoButtonColor = false
    ButtonBg.Parent = ToggleFrame

    local UICornerBtn = Instance.new("UICorner")
    UICornerBtn.CornerRadius = UDim.new(1, 0)
    UICornerBtn.Parent = ButtonBg

    local Circle = Instance.new("Frame")
    Circle.Size = UDim2.new(0, 20, 0, 20)
    Circle.Position = UDim2.new(0, 2, 0.5, -10)
    Circle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    Circle.Parent = ButtonBg
    
    local UICornerCircle = Instance.new("UICorner")
    UICornerCircle.CornerRadius = UDim.new(1, 0)
    UICornerCircle.Parent = Circle

    local isOn = false

    ButtonBg.MouseButton1Click:Connect(function()
        isOn = not isOn
        callback(isOn)

        local targetPos, targetColor
        if isOn then
            targetPos = UDim2.new(1, -22, 0.5, -10)
            targetColor = Color3.fromRGB(0, 255, 150)
        else
            targetPos = UDim2.new(0, 2, 0.5, -10)
            targetColor = Color3.fromRGB(100, 100, 100)
        end
        TweenService:Create(Circle, TweenInfo.new(0.2), {Position = targetPos}):Play()
        TweenService:Create(ButtonBg, TweenInfo.new(0.2), {BackgroundColor3 = targetColor}):Play()
    end)
end

----------------------------------------------------------
-- 3. LOGIC CHỨC NĂNG
----------------------------------------------------------

-- Ghost Mode
local noclipConnection = nil
createToggle("Ghost Mode", 40, function(state)
    if state then
        noclipConnection = RunService.Stepped:Connect(function()
            if LocalPlayer.Character then
                for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                    if part:IsA("BasePart") and part.CanCollide == true then
                        part.CanCollide = false
                    end
                end
            end
        end)
    else
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
    end
end)

-- Ply Speed
createToggle("Ply Speed", 90, function(state)
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("Humanoid") then
        if state then
            char.Humanoid.WalkSpeed = 50
        else
            char.Humanoid.WalkSpeed = 16
        end
    end
end)
